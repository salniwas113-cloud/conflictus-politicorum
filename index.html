<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="  width=device-width, initial-scale=1.0">
    <title>Conflictus Politicorum</title>
    
    <!-- Bootstrap 5 + Dark Mode Support -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        #map { flex: 1; }
        #sidebar { width: 350px; padding: 15px; overflow-y: auto; background: var(--bs-body-bg); }
        .panel { margin-bottom: 20px; }
        .resource { font-weight: bold; }
        #dark-mode-toggle i { font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>
    <div class="d-flex flex-column h-100">
        <!-- Header -->
        <div class="bg-primary text-white p-3 d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0">Conflictus Politicorum</h1>
            <div id="dark-mode-toggle">
                <i class="bi bi-sun-fill" id="light-icon"></i>
                <i class="bi bi-moon-fill d-none" id="dark-icon"></i>
            </div>
        </div>
        
        <div class="d-flex flex-row flex-grow-1">
            <!-- Map -->
            <div id="map"></div>
            
            <!-- Sidebar -->
            <div id="sidebar" class="border-start">
                <div id="login-panel" class="panel">
                    <h5>Welcome</h5>
                    <p>Initializing game...</p>
                </div>
                
                <div id="no-nation-panel" class="panel d-none">
                    <div class="alert alert-info">
                        <strong>Start your nation!</strong><br>
                        Click on an unclaimed country on the map to found your nation.
                    </div>
                </div>
                
                <div id="nation-panel" class="panel d-none">
                    <h5 id="nation-name"></h5>
                    <p id="country-name"></p>
                    
                    <div class="mb-3">
                        <strong>Alliance:</strong> <span id="alliance-display">None</span>
                        <div class="mt-2">
                            <div class="input-group input-group-sm">
                                <input type="text" id="alliance-input" class="form-control" placeholder="Alliance name">
                                <button id="create-alliance" class="btn btn-success">Create</button>
                                <button id="join-alliance" class="btn btn-primary">Join</button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>Resources (updates hourly)</h6>
                    <div id="resources">
                        <div class="resource">Gold: <span id="gold">0</span></div>
                        <div class="resource">Iron: <span id="iron">0</span></div>
                        <div class="resource">Oil: <span id="oil">0</span></div>
                    </div>
                    
                    <hr>
                    
                    <h6>Buildings</h6>
                    <div id="buildings"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JS (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===== REPLACE WITH YOUR OWN SUPABASE CONFIG =====
        const supabaseUrl = 'https://YOUR_PROJECT.supabase.co';
        const supabaseAnonKey = 'YOUR_ANON_PUBLIC_KEY';
        const supabase = Supabase.createClient(supabaseUrl, supabaseAnonKey);
        // ===============================================

        let map, geoLayer, playerId = localStorage.getItem('playerId');
        if (!playerId) {
            playerId = crypto.randomUUID();
            localStorage.setItem('playerId', playerId);
        }
        let currentNation = null;
        let isoToLayer = {};

        // Country base production (per hour)
        const countryProduction = {
            'ZAF': { gold: 60, iron: 120, oil: 40 },
            'SAU': { gold: 80, iron: 20, oil: 150 },
            'RUS': { gold: 50, iron: 80, oil: 130 },
            'CHN': { gold: 100, iron: 200, oil: 50 },
            'USA': { gold: 150, iron: 100, oil: 80 },
            'AUS': { gold: 70, iron: 180, oil: 60 },
            'BRA': { gold: 40, iron: 150, oil: 70 },
            'default': { gold: 30, iron: 40, oil: 20 }
        };

        // Dark mode toggle
        document.getElementById('dark-mode-toggle').addEventListener('click', () => {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-bs-theme') === 'dark';
            html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
            document.getElementById('light-icon').classList.toggle('d-none', !isDark);
            document.getElementById('dark-icon').classList.toggle('d-none', isDark);
            updateTileLayer(isDark ? 'dark' : 'light');
        });

        const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });
        const darkTiles = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap &copy; CartoDB'
        });

        function updateTileLayer(mode) {
            if (map) {
                if (mode === 'dark') {
                    map.removeLayer(lightTiles);
                    darkTiles.addTo(map);
                } else {
                    map.removeLayer(darkTiles);
                    lightTiles.addTo(map);
                }
            }
        }

        function initMap() {
            map = L.map('map').setView([-26, 28], 4); // Centered on Southern Africa
            lightTiles.addTo(map);

            fetch('https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson')
                .then(r => r.json())
                .then(data => {
                    geoLayer = L.geoJSON(data, {
                        style: () => ({ fillColor: '#888', weight: 1, color: '#333', fillOpacity: 0.3 }),
                        onEachFeature: (feature, layer) => {
                            const iso = feature.properties.ISO_A3;
                            if (iso && iso !== '-99') isoToLayer[iso] = layer;
                            layer.on('click', () => showCountryPopup(feature, layer));
                        }
                    }).addTo(map);

                    loadAllCountriesStyles();
                    setupRealtime();
                })
                .catch(err => {
                    console.error('Failed to load country outlines:', err);
                    L.popup({permanent: true})
                        .setLatLng([-26, 28])
                        .setContent('Country outlines failed to load.<br>Alliance colors may not update.<br>Check console.')
                        .openOn(map);
                });
        }

        async function loadAllCountriesStyles() {
            try {
                const { data } = await supabase.from('countries').select('*');
                if (data) {
                    data.forEach(c => {
                        const layer = isoToLayer[c.iso];
                        if (layer && c.alliance_color) {
                            layer.setStyle({ fillColor: c.alliance_color, fillOpacity: 0.7 });
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load country styles:', err);
            }
        }

        function setupRealtime() {
            try {
                supabase.channel('countries-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'countries' }, payload => {
                        const record = payload.new || payload.old || {};
                        const iso = record.iso;
                        const layer = isoToLayer[iso];
                        if (layer) {
                            const color = (payload.new && payload.new.alliance_color) ? payload.new.alliance_color : '#888';
                            const opacity = (payload.new && payload.new.alliance_color) ? 0.7 : 0.3;
                            layer.setStyle({ fillColor: color, fillOpacity: opacity });
                        }
                    })
                    .subscribe();
            } catch (err) {
                console.error('Realtime subscription failed (non-critical):', err);
            }
        }

        async function showCountryPopup(feature, layer) {
            const iso = feature.properties.ISO_A3;
            const name = feature.properties.NAME || 'Unknown';
            if (!iso || iso === '-99') return;

            let countryData = {};
            try {
                const { data: rows } = await supabase.from('countries').select('*').eq('iso', iso);
                countryData = rows && rows[0] || {};
            } catch (err) {
                console.error('Failed to fetch country data:', err);
            }

            let content = `<h6>${name}</h6>`;
            if (countryData.nation_name) {
                content += `<p>Nation: <strong>${countryData.nation_name}</strong></p>`;
                if (countryData.alliance) content += `<p>Alliance: <strong>${countryData.alliance}</strong></p>`;
            } else if (!currentNation) {
                content += `<p>Unclaimed!</p>
                            <button class="btn btn-sm btn-success" onclick="claimCountry('${iso}', '${name}')">Found Nation Here</button>`;
            } else {
                content += `<p>Unclaimed</p>`;
            }
            layer.bindPopup(content).openPopup();
        }

        window.claimCountry = async (iso, countryName) => {
            if (currentNation) return alert('You already have a nation!');
            const nationName = prompt("Enter your nation name:", "My Nation");
            if (!nationName) return;

            try {
                const { data: existing } = await supabase.from('countries').select('iso').eq('iso', iso);
                if (existing && existing.length > 0) return alert('This country is already claimed!');

                const initialResources = { gold: 500, iron: 300, oil: 200 };
                const buildings = { goldMine: 0, ironMine: 0, oilMine: 0 };

                await supabase.from('nations').insert({
                    owner: playerId,
                    nation_name: nationName,
                    country_iso: iso,
                    country_name: countryName,
                    resources: initialResources,
                    buildings: buildings,
                    last_tick: Date.now()
                });

                await supabase.from('countries').upsert({
                    iso: iso,
                    nation_name: nationName,
                    owner: playerId
                });

                await loadNation(); // reload to show new nation
            } catch (err) {
                console.error(err);
                alert('Claim failed - check console');
            }
        };

        async function loadNation() {
            try {
                const { data, error } = await supabase.from('nations').select('*').eq('owner', playerId).maybeSingle();
                if (error) throw error;

                currentNation = data;

                if (currentNation) {
                    try {
                        const { data: countryData } = await supabase.from('countries').select('alliance, alliance_color').eq('iso', currentNation.country_iso).single();
                        currentNation.alliance = (countryData && countryData.alliance) || null;
                    } catch (err) {
                        console.error('Failed to load alliance data:', err);
                    }

                    document.getElementById('no-nation-panel').classList.add('d-none');
                    document.getElementById('nation-panel').classList.remove('d-none');

                    document.getElementById('nation-name').textContent = currentNation.nation_name;
                    document.getElementById('country-name').textContent = currentNation.country_name;
                    document.getElementById('alliance-display').textContent = currentNation.alliance || 'None';

                    updateResourcesDisplay();
                    buildUI();
                    calculateResources();
                    setInterval(calculateResources, 60000);
                } else {
                    document.getElementById('no-nation-panel').classList.remove('d-none');
                }
            } catch (err) {
                console.error('Database error:', err);
                document.getElementById('no-nation-panel').classList.remove('d-none');
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger';
                alertDiv.innerHTML = '<strong>Database connection failed</strong><br>Check:<br>• Supabase URL & anon key<br>• Tables created exactly<br>• Row Level Security DISABLED on all three tables<br>See browser console (F12) for details.';
                document.getElementById('sidebar').insertBefore(alertDiv, document.getElementById('no-nation-panel'));
            } finally {
                document.getElementById('login-panel').classList.add('d-none');
            }
        }

        async function calculateResources() {
            if (!currentNation) return;
            const now = Date.now();
            const hoursPassed = Math.floor((now - currentNation.last_tick) / (1000 * 60 * 60));
            if (hoursPassed > 0) {
                const prod = countryProduction[currentNation.country_iso] || countryProduction['default'];
                const goldProd = prod.gold + (currentNation.buildings.goldMine || 0) * 15;
                const ironProd = prod.iron + (currentNation.buildings.ironMine || 0) * 20;
                const oilProd = prod.oil + (currentNation.buildings.oilMine || 0) * 15;

                currentNation.resources.gold += goldProd * hoursPassed;
                currentNation.resources.iron += ironProd * hoursPassed;
                currentNation.resources.oil += oilProd * hoursPassed;

                const newTick = currentNation.last_tick + hoursPassed * (1000 * 60 * 60);
                currentNation.last_tick = newTick;

                try {
                    await supabase.from('nations').update({
                        resources: currentNation.resources,
                        last_tick: newTick
                    }).eq('owner', playerId);
                } catch (err) {
                    console.error('Failed to save resources:', err);
                }

                updateResourcesDisplay();
            }
        }

        function updateResourcesDisplay() {
            if (!currentNation) return;
            document.getElementById('gold').textContent = Math.floor(currentNation.resources.gold);
            document.getElementById('iron').textContent = Math.floor(currentNation.resources.iron);
            document.getElementById('oil').textContent = Math.floor(currentNation.resources.oil);
        }

        function buildUI() {
            const buildingsDiv = document.getElementById('buildings');
            buildingsDiv.innerHTML = '';
            const types = [
                {key: 'goldMine', name: 'Gold Mine', baseCost: 200},
                {key: 'ironMine', name: 'Iron Mine', baseCost: 300},
                {key: 'oilMine', name: 'Oil Mine', baseCost: 400}
            ];
            types.forEach(type => {
                const level = currentNation.buildings[type.key] || 0;
                const cost = type.baseCost * Math.pow(2, level);
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-primary me-2 mb-2';
                btn.textContent = `${type.name} Lv.${level} (Cost: ${cost} Gold)`;
                if (currentNation.resources.gold >= cost) {
                    btn.disabled = false;
                    btn.onclick = () => upgradeBuilding(type.key, cost);
                } else {
                    btn.disabled = true;
                }
                buildingsDiv.appendChild(btn);
            });
        }

        async function upgradeBuilding(key, cost) {
            currentNation.resources.gold -= cost;
            currentNation.buildings[key] = (currentNation.buildings[key] || 0) + 1;

            try {
                await supabase.from('nations').update({
                    resources: currentNation.resources,
                    buildings: currentNation.buildings
                }).eq('owner', playerId);
                updateResourcesDisplay();
                buildUI();
            } catch (err) {
                console.error('Upgrade failed:', err);
                alert('Upgrade failed - check console');
            }
        }

        // Alliance handling
        document.getElementById('create-alliance').onclick = async () => {
            const name = document.getElementById('alliance-input').value.trim();
            if (!name) return alert('Enter alliance name');
            const color = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');

            try {
                const { error } = await supabase.from('alliances').insert({ name, leader: playerId, color });
                if (error) throw error;

                await supabase.from('countries').update({ alliance: name, alliance_color: color }).eq('iso', currentNation.country_iso);
                currentNation.alliance = name;
                document.getElementById('alliance-display').textContent = name;
            } catch (err) {
                console.error(err);
                alert('Failed to create alliance (name taken?)');
            }
        };

        document.getElementById('join-alliance').onclick = async () => {
            const name = document.getElementById('alliance-input').value.trim();
            if (!name) return alert('Enter alliance name');

            try {
                const { data: allianceData, error } = await supabase.from('alliances').select('color').eq('name', name).single();
                if (error || !allianceData) throw error || 'Not found';

                await supabase.from('countries').update({ alliance: name, alliance_color: allianceData.color }).eq('iso', currentNation.country_iso);
                currentNation.alliance = name;
                document.getElementById('alliance-display').textContent = name;
            } catch (err) {
                alert('Alliance not found');
            }
        };

        // Start
        initMap();
        loadNation();
    </script>
</body>
</html>